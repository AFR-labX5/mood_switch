<script>
let currentMood = null;
let seconds = 0;
let timerInterval;
let lastUpdateTime = null;

const moodImages = {
  positive: 'https://4kwallpapers.com/images/walls/thumbs_3t/21426.jpg',
  negative: 'https://images6.alphacoders.com/917/thumb-1920-917631.png',
  neutral: 'https://images.alphacoders.com/699/thumb-1920-699582.jpg'
};

let moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];
let cumulativeTime = JSON.parse(localStorage.getItem('cumulativeTime')) || { positive: 0, negative: 0, neutral: 0 };
const logList = document.getElementById('logList');
renderLog();
renderCumulative();

// ðŸ”¹ Restore previous mood and timer when reloading
window.onload = () => {
  const savedMood = localStorage.getItem('currentMood');
  const savedStart = localStorage.getItem('moodStartTime');
  if (savedMood && savedStart) {
    currentMood = savedMood;
    const elapsed = Math.floor((Date.now() - parseInt(savedStart)) / 1000);
    seconds = elapsed;
    updateMoodAppearance(savedMood);
    startTimer(); // resume visible timer
  }
};

function setMood(mood) {
  // Record previous mood if exists
  if(currentMood) {
    recordCurrentMood();
  }

  // Update current mood
  currentMood = mood;
  localStorage.setItem('currentMood', mood);
  localStorage.setItem('moodStartTime', Date.now().toString());

  updateMoodAppearance(mood);

  seconds = 0;
  startTimer();
}

function updateMoodAppearance(mood) {
  const colors = { positive:'#007bff', negative:'#5C4033', neutral:'#FFC107' };
  const texts = { positive:'Positive ðŸ˜Š', negative:'Angry/Negative âš¡', neutral:'Neutral â˜€ï¸' };
  document.body.style.backgroundColor = colors[mood];
  document.getElementById('moodText').textContent = texts[mood];
  document.getElementById('moodImage').src = moodImages[mood];
}

function startTimer() {
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const start = parseInt(localStorage.getItem('moodStartTime'));
    const elapsed = Math.floor((Date.now() - start) / 1000);
    seconds = elapsed;
    const mins = String(Math.floor(seconds / 60)).padStart(2,'0');
    const secs = String(seconds % 60).padStart(2,'0');
    document.getElementById('timer').textContent = `${mins}:${secs}`;
  }, 1000);
}

function recordCurrentMood() {
  const start = parseInt(localStorage.getItem('moodStartTime'));
  const duration = Math.floor((Date.now() - start) / 1000);
  moodLog.push({
    mood: currentMood,
    duration,
    timestamp: new Date().toLocaleString()
  });
  cumulativeTime[currentMood] += duration;
  saveData();
}

function resetAll() {
  if(timerInterval) clearInterval(timerInterval);
  seconds = 0;
  document.getElementById('timer').textContent = "00:00";
  currentMood = null;
  document.getElementById('moodText').textContent = "Choose Your Mood";
  document.getElementById('moodImage').src = "";
  document.body.style.backgroundColor = "";
  moodLog = [];
  cumulativeTime = { positive: 0, negative: 0, neutral: 0 };
  localStorage.clear();
  renderLog();
  renderCumulative();
}

function saveData() {
  localStorage.setItem('moodLog', JSON.stringify(moodLog));
  localStorage.setItem('cumulativeTime', JSON.stringify(cumulativeTime));
  renderLog();
  renderCumulative();
}

function renderLog() {
  logList.innerHTML = '';
  moodLog.slice(-10).reverse().forEach(entry => {
    const li = document.createElement('li');
    const mins = String(Math.floor(entry.duration / 60)).padStart(2,'0');
    const secs = String(entry.duration % 60).padStart(2,'0');
    li.textContent = `[${entry.timestamp}] ${entry.mood.toUpperCase()} â€“ ${mins}:${secs}`;
    logList.appendChild(li);
  });
}

function renderCumulative() {
  document.getElementById('positiveTime').textContent = `Positive: ${formatTime(cumulativeTime.positive)}`;
  document.getElementById('negativeTime').textContent = `Angry/Negative: ${formatTime(cumulativeTime.negative)}`;
  document.getElementById('neutralTime').textContent = `Neutral: ${formatTime(cumulativeTime.neutral)}`;
}

function formatTime(seconds) {
  const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
  const secs = String(seconds % 60).padStart(2, '0');
  return `${mins}:${secs}`;
}

// ðŸ”¹ Save current moodâ€™s data before closing
window.addEventListener('beforeunload', () => {
  if(currentMood) {
    recordCurrentMood();
  }
});
</script>
